// ==UserScript==
// @name         BilimalX
// @namespace    noreehn.
// @version      2.0
// @description  Небольшие удобства для работы в электроном журнале school.bilimal.kz
// @author       https://t.me/noreehn
// @match        https://school.bilimal.kz/*
// @icon         https://raw.githubusercontent.com/nxreehn/bilimalX/main/bilimalXIcon.png
// @homepageURL  https://github.com/nxreehn/bilimalX/blob/main/README.md
// @updateURL    https://raw.githubusercontent.com/nxreehn/bilimalX/main/bilimalX
// @downloadURL  https://raw.githubusercontent.com/nxreehn/bilimalX/main/bilimalX
// @grant GM_setValue
// @grant GM_getValue
// @grant GM_setClipboard
// ==/UserScript==

//glass header
const mainHeader = document.querySelector('.main-header');
mainHeader.style.background = 'rgba(109, 81, 81, 0.15)';
mainHeader.style.boxShadow = '0 8px 32px 0 rgba(31, 38, 135, 0.37)';
mainHeader.style.backdropFilter = 'blur(8px)';
mainHeader.style.webkitBackdropFilter = 'blur(8px)';
mainHeader.style.borderRadius = '10px';
mainHeader.style.border = '1px solid rgba(255, 255, 255, 0.18)';

//bell icon remove
const elementToRemoveBell = document.querySelector('a.fpa_link.main-header-notifications-link.bell');
if (elementToRemoveBell) {
    elementToRemoveBell.parentNode.removeChild(elementToRemoveBell);
}

//notification icon remove
const elementToRemoveNotificationIcon = document.querySelector('a.fpa_link.main-header-notifications-link');
if (elementToRemoveNotificationIcon) {
    elementToRemoveNotificationIcon.parentNode.removeChild(elementToRemoveNotificationIcon);
}
// //title text remove
// const titleTextRemove = document.querySelector('.logo-title');
// if (titleTextRemove) {
//     titleTextRemove.parentNode.removeChild(titleTextRemove);
// }

// //logo image remove
// const logoRemove = document.querySelector('.main-header-logo');
// if (logoRemove) {
//     logoRemove.parentNode.removeChild(logoRemove);
// }

//add new animated icon
const circle = document.createElement('div');
circle.classList.add('circle');
circle.style.width = '50px';
circle.style.height = '50px';
circle.style.borderRadius = '50%';
circle.style.backgroundColor = '#ffffff';
circle.style.display = 'flex';
circle.style.alignItems = 'center';
circle.style.justifyContent = 'center';
circle.style.marginLeft = '15px';
const animationContainer = document.createElement('div');
animationContainer.style.width = '30px';
animationContainer.style.height = '30px';
circle.appendChild(animationContainer);
const script = document.createElement('script');
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.9/lottie.min.js';
script.onload = function () {
  const animation = lottie.loadAnimation({
    container: animationContainer,
    renderer: 'svg',
    loop: false,
    autoplay: true,
    path: 'https://raw.githubusercontent.com/nxreehn/bilimalX/main/notification.json'
  });
  circle.addEventListener('click', function (event) {
    event.preventDefault();
    animation.play();
  });
};
document.head.appendChild(script);
const mainHeaderUser = document.querySelector('.main-header-user.ml-4');
mainHeaderUser.parentNode.insertBefore(circle, mainHeaderUser);
circle.style.transition = 'background-color 0.5s';
circle.addEventListener('mouseenter', function (event) {
  circle.style.backgroundColor = '#28a745';
  circle.title="Уведомления";
});
circle.addEventListener('mouseleave', function (event) {
  circle.style.backgroundColor = '#ffffff';
});
const circleElement = document.querySelector('.circle');
if (circleElement) {
  circleElement.addEventListener('click', function(event) {
    event.preventDefault();
    window.location.href = '/cabinet_teacher/notification';
  });
}

//new logo
var logoElement = document.querySelector('.main-header-logo');
var newImage = document.createElement('img');
newImage.src = "https://raw.githubusercontent.com/nxreehn/bilimalX/main/BilimalXLogo.png";
newImage.alt = "BilimalX Logo";
logoElement.textContent = '';
logoElement.appendChild(newImage);
newImage.addEventListener('click', function() {
  window.location.href = '/cabinet_teacher/';
});
var styleElement = document.createElement('style');
styleElement.textContent = `
@-webkit-keyframes slide-in-blurred-left {
  0% {
    -webkit-transform: translateX(-1000px) scaleX(2.5) scaleY(0.2);
            transform: translateX(-1000px) scaleX(2.5) scaleY(0.2);
    -webkit-transform-origin: 100% 50%;
            transform-origin: 100% 50%;
    -webkit-filter: blur(40px);
            filter: blur(40px);
    opacity: 0;
  }
  100% {
    -webkit-transform: translateX(0) scaleY(1) scaleX(1);
            transform: translateX(0) scaleY(1) scaleX(1);
    -webkit-transform-origin: 50% 50%;
            transform-origin: 50% 50%;
    -webkit-filter: blur(0);
            filter: blur(0);
    opacity: 1;
  }
}

@keyframes slide-in-blurred-left {
  0% {
    -webkit-transform: translateX(-1000px) scaleX(2.5) scaleY(0.2);
            transform: translateX(-1000px) scaleX(2.5) scaleY(0.2);
    -webkit-transform-origin: 100% 50%;
            transform-origin: 100% 50%;
    -webkit-filter: blur(40px);
            filter: blur(40px);
    opacity: 0;
  }
  100% {
    -webkit-transform: translateX(0) scaleY(1) scaleX(1);
            transform: translateX(0) scaleY(1) scaleX(1);
    -webkit-transform-origin: 50% 50%;
            transform-origin: 50% 50%;
    -webkit-filter: blur(0);
            filter: blur(0);
    opacity: 1;
  }
}

.main-header-logo img {
  animation: slide-in-blurred-left 0.6s cubic-bezier(0.230, 1.000, 0.320, 1.000) both;
  width: 200px;
  height: auto; 
}
`;

document.head.appendChild(styleElement);


//return pluses to sor
document.querySelectorAll('td.mark.current.sor').forEach((e) => {
    const tasksDiv = e.querySelector('#tasks');
    if (!e.querySelector('.tooltipster.mark_symbol.is-update') && tasksDiv) {
        tasksDiv.innerHTML = '<div class="mark-plus">+</div>';
    } else if (!e.querySelector('.tooltipster.mark_symbol.is-update')) {
        e.insertAdjacentHTML('beforeend', '<div id="tasks" style="display: flex; align-items: center; justify-content: flex-end; padding: 5px;" data-bg="none"><div class="mark-plus">+</div></div>');
    }
});

//return pluses to soch
document.querySelectorAll('td.mark.current.soch').forEach((e) => {
    const tasksDiv = e.querySelector('#tasks');
    if (!e.querySelector('.tooltipster.mark_symbol.is-update') && tasksDiv) {
        tasksDiv.innerHTML = '<div class="mark-plus">+</div>';
    } else if (!e.querySelector('.tooltipster.mark_symbol.is-update')) {
        e.insertAdjacentHTML('beforeend', '<div id="tasks" style="display: flex; align-items: center; justify-content: flex-end; padding: 5px;" data-bg="none"><div class="mark-plus">+</div></div>');
    }
});

//return all pluses
document.querySelectorAll('td.mark.current').forEach((e) => {
    const tasksDiv = e.querySelector('#tasks');
    if (!e.querySelector('.tooltipster.mark_symbol.is-update') && tasksDiv) {
        tasksDiv.innerHTML = '<div class="mark-plus">+</div>';
    } else if (!e.querySelector('.tooltipster.mark_symbol.is-update')) {
        e.insertAdjacentHTML('beforeend', '<div id="tasks" style="display: flex; align-items: center; justify-content: flex-end; padding: 5px;" data-bg="none"><div class="mark-plus">+</div></div>');
    }
});

//create "save all ktp topics" button to copy all topics into clipboard
function addCopyButton() {
  const existingButton = document.querySelector('.btn-copy-topics');
  if (existingButton) {
    return; // Если кнопка уже существует, не добавляем новую
  }

  const button = document.createElement('button');
  button.innerText = 'Копировать темы в этой четверти';
  button.classList.add('btn', 'btn-green', 'btn-mini', 'btn-copy-topics');
  button.style.marginLeft = '4px';
  button.addEventListener('click', function() {
    const names = document.querySelectorAll(".ctp-view-lplan");
    const data = [];

    names.forEach(name => {
      const tagA = name.querySelector('span');

      if (tagA) {
        const pullRightElement = tagA.querySelector('.pull-right');
        if (pullRightElement) {
          pullRightElement.remove();
        }
        data.push(tagA.textContent.trim().replace(/^\d+\.\s/, ''));
      }
    });
    const joinedData = data.join('\n');
    const textarea = document.createElement('textarea');
    textarea.value = joinedData;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    alert('Темы скопированы!');
  });

  const targetElement = document.querySelector('.ctp-lplans .btn.btn-green.btn-mini');
  if (targetElement) {
    targetElement.parentNode.insertBefore(button, targetElement.nextSibling);
  }
}

addCopyButton();

const observer = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.addedNodes) {
      for (let i = 0; i < mutation.addedNodes.length; i++) {
        const node = mutation.addedNodes[i];
        if (node.classList && node.classList.contains('ctp-view-lplan')) {
          addCopyButton();
          break;
        }
      }
    }
  });
});

const config = { childList: true, subtree: true };
observer.observe(document.body, config);
